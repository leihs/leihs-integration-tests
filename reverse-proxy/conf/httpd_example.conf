ServerName localhost
Listen 3200
PidFile tmp/httpd.pid

LoadModule authz_core_module mod_authz_core.so
LoadModule authz_host_module mod_authz_host.so
LoadModule dir_module mod_dir.so
LoadModule env_module mod_env.so
LoadModule headers_module mod_headers.so
LoadModule expires_module mod_expires.so
LoadModule mime_module mod_mime.so
LoadModule log_config_module mod_log_config.so
LoadModule rewrite_module mod_rewrite.so
LoadModule alias_module mod_alias.so
LoadModule proxy_module mod_proxy.so
LoadModule proxy_http_module mod_proxy_http.so
LoadModule proxy_wstunnel_module mod_proxy_wstunnel.so
LoadModule unixd_module modules/mod_unixd.so

LoadModule cache_module modules/mod_cache.so
LoadModule cache_disk_module modules/mod_cache_disk.so
LoadModule cache_socache_module modules/mod_cache_socache.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so

###############################################################################
### Logging ###################################################################
###############################################################################

ErrorLog logs/error.log
LogLevel info
CustomLog logs/access.log "%h %l %u %t %{cache-status}e \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\""


###############################################################################
###############################################################################
###############################################################################


RewriteEngine on
AllowEncodedSlashes NoDecode

DocumentRoot "html"
<Directory "html">
  AllowOverride all
  Require all granted
</Directory>



###############################################################################
### Legacy Assets #############################################################
###############################################################################
#
ProxyPass /assets !

Alias /assets ../../legacy/public/assets
<Directory /leihs/legacy/public/assets>
    Require all granted
</Directory>

<LocationMatch "^/assets/.*$">
    Header unset ETag
    FileETag None
    # RFC says only cache for 1 year
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
</LocationMatch>


###############################################################################
### Reverse proxy #############################################################
###############################################################################

PassEnv LEIHS_LEGACY_PORT LEIHS_MY_PORT

Define leihs_legacy_port 3210
Define leihs_admin_port 3220
Define leihs_procure_port 3230
Define leihs_procure_client_port 3231
Define leihs_my_port 3240

RewriteRule ^/admin/users$ /admin/users/ [R]
#RewriteRule ^/logout$ /auth/sign-out

## my 
ProxyPassMatch "^/$"  				  http://localhost:${leihs_my_port}/ 									      nocanon retry=0
ProxyPass /my        					  http://localhost:${leihs_my_port}/my 		          		    nocanon retry=0
ProxyPass /user       					http://localhost:${leihs_my_port}/user            		    nocanon retry=0
ProxyPass /sign-in   					  http://localhost:${leihs_my_port}/sign-in                 nocanon retry=0
ProxyPass /sign-out  					  http://localhost:${leihs_my_port}/sign-out                nocanon retry=0

## legacy admin
ProxyPass /admin/audits          http://localhost:${leihs_legacy_port}/admin/audits            nocanon retry=0
ProxyPass /admin/buildings       http://localhost:${leihs_legacy_port}/admin/buildings         nocanon retry=0
ProxyPass /admin/field_settings  http://localhost:${leihs_legacy_port}/admin/field_settings    nocanon retry=0
ProxyPass /admin/inventory_pools http://localhost:${leihs_legacy_port}/admin/inventory_pools   nocanon retry=0
ProxyPass /admin/languages       http://localhost:${leihs_legacy_port}/admin/languages         nocanon retry=0
ProxyPass /admin/mail_templates  http://localhost:${leihs_legacy_port}/admin/mail_templates    nocanon retry=0
ProxyPass /admin/rooms           http://localhost:${leihs_legacy_port}/admin/rooms             nocanon retry=0
ProxyPass /admin/settings        http://localhost:${leihs_legacy_port}/admin/settings          nocanon retry=0
ProxyPass /admin/statistics      http://localhost:${leihs_legacy_port}/admin/statistics        nocanon retry=0
ProxyPass /admin/suppliers       http://localhost:${leihs_legacy_port}/admin/suppliers         nocanon retry=0
 

## admin & API
ProxyPass /admin    					  http://localhost:${leihs_admin_port}/admin                  nocanon retry=0 keepalive=On  timeout=180

# procure2
ProxyPass /procure/graphql			http://localhost:${leihs_procure_port}/procure/graphql		  nocanon retry=0
ProxyPass /procure/images			  http://localhost:${leihs_procure_port}/procure/images		    nocanon retry=0
ProxyPass /procure/attachments	http://localhost:${leihs_procure_port}/procure/attachments	nocanon retry=0
ProxyPass /procure			        http://localhost:${leihs_procure_client_port}/procure				nocanon retry=0

## everything else goes to legacy
ProxyPass /       http://localhost:${leihs_legacy_port}/       nocanon retry=0



###############################################################################
### Cache #####################################################################
###############################################################################

# DiskCache
# we don't use the disk cache, absolute paths are nasty to handle
CacheRoot /Users/thomas/Programming/LEIHS/leihs_v5/integration-tests/reverse-proxy/tmp/cache/cache

# in Memory cache
CacheSocache shmcb
CacheSocacheMaxSize 9999999

CacheEnable socache "/my"
CacheEnable socache "/admin"
CacheQuickHandler on
CacheHeader on 

CacheIgnoreHeaders Set-Cookie Cookie Cookie2 X-Forwarded-For X-Forwarded-Host

# vim: syntax=apache

