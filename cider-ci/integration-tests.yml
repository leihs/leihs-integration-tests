task_defaults:

  include:
    - cider-ci/task_components/bundle.yml
    - cider-ci/task_components/container.yml

  traits:
    vagrant: yes
    virtualbox: yes
    Firefox ESR 60: yes

  environment_variables:
    # force using only `FIREFOX_ESR_60_PATH` from executor
    FIREFOX_PATH: ''
    FIREFOX_ESR_PATH: ''

  ports:
    LEIHS_HOST_PORT_HTTP: { min: 10101, max: 10200 }
    LEIHS_HOST_PORT_HTTPS: { min: 10201, max: 10300 }
    LEIHS_HOST_PORT_POSTGRES: { min: 10301, max: 10400 }
    LEIHS_HOST_PORT_SSH: { min: 10401, max: 10500 }

  max_trials: 3

  git_options:
    submodules:
      include_match: ^.+$

  trial_attachments:
    screenshots:
      include_match: tmp\/(.*-|)screenshots\/.*\.png$
      content_type: image/png

  scripts:
    test:
      timeout: 30 Minutes # long timeout as long as we run all specs in 1 task
      body: |
        set -eux
        export PATH=~/.rubies/$RUBY/bin:$PATH
        mkdir -p log
        xvfb-run -a -e log/xvfb.log \
          bundle exec rspec "$CIDER_CI_TASK_FILE"

# TEMP: run all specs for now (setup is not cached yet and there are only few specs)
tasks:
  all:
    environment_variables:
      CIDER_CI_TASK_FILE: 'spec'

# # generate_tasks:
# #   include_match: 'spec/(system\/.*_spec\.rb|features\/.*\.feature|)'
#
# # tasks-specific config:
# tasks:
#   spec/features/initial_setup.feature:
#     environment_variables: { CIDER_CI_TASK_FILE: spec/features/initial_setup.feature }
#   # spec/example_spec.rb:
#   #   scripts:
#   #     prepare-config:
#   #       body: 'echo preparation'
#   #     test:
#   #       start_when:
#   #         config is prepared: { script_key: prepare-config }
